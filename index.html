<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Training Asset Database</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 
    *** UNITY WEBGL INTEGRATION: STEP 1 (Add Unity Loader Script) ***
    -->
    <script src="Build/WebGL.loader.js"></script> 
    
    <style>
        /* Custom styles for the WebGL container */
        #unity-webgl-area {
            height: 100%;
            width: 100%;
            display: flex; 
            justify-content: center;
            align-items: center;
        }
        /* Hide scrollbar for aesthetics */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Style the canvas specifically for Unity (Unity will often handle this dynamically) */
        #unity-canvas {
            width: 100%;
            height: 100%;
            display: block; 
        }
        /* Ensures the transition is smooth when toggling dark mode */
        body {
            transition: background-color 0.3s;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode based on 'dark' class on html tag
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#1e293b', // slate-800
                        'accent': 'rgb(52, 211, 163)', // emerald-400
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans antialiased h-screen overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center z-10 border-b border-gray-200 dark:border-gray-700">
        <h1 class="text-2xl font-bold text-indigo-700 dark:text-emerald-400">Training Asset Catalog</h1>
        <div class="flex items-center space-x-3">
            <button id="view-mode-button" class="px-4 py-2 bg-indigo-500 dark:bg-emerald-500 text-white text-sm font-medium rounded-full hover:bg-indigo-600 dark:hover:bg-emerald-600 transition duration-150 shadow-md">
                Asset Dashboard
            </button>
            
            <!-- Dark Mode Toggle Switch -->
            <button id="dark-mode-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150" aria-label="Toggle Dark Mode">
                <svg class="w-6 h-6 sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg class="w-6 h-6 moon-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
    </header>

    <!-- Main Content and Sidebar Container -->
    <main class="flex-grow flex flex-col lg:flex-row overflow-y-auto lg:overflow-hidden">
        
        <!-- Asset List (Left Panel) -->
        <div id="asset-list" class="w-full lg:w-96 p-4 border-r border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 overflow-y-auto no-scrollbar flex-shrink-0 transition-all duration-300 ease-in-out">
            <h2 class="text-xl font-semibold mb-3 text-gray-800 dark:text-gray-200">Asset Catalog</h2>

            <!-- Category Tab Bar (Row 1: Main Categories) -->
            <div id="category-tabs" class="flex justify-around p-1 bg-gray-100 dark:bg-gray-700 rounded-xl mb-2 shadow-inner">
                <!-- Tabs will be dynamically created here by JS -->
            </div>

            <!-- Subcategory Bar (Row 2: Sub-categories) -->
            <div id="subcategory-container" 
                 class="mb-4 transition-all duration-300 ease-in-out opacity-0 max-h-0 overflow-hidden">
                <div id="subcategory-tabs" class="flex flex-wrap gap-2 p-2 bg-gray-100 dark:bg-gray-700 rounded-xl shadow-inner border border-gray-200 dark:border-gray-600">
                    <!-- Subcategory buttons will be rendered here -->
                </div>
            </div>

            <!-- Search Bar -->
            <div class="mb-4">
                <input type="text" id="asset-search" placeholder="Search by Name, ID, Tags, or Description..." 
                       class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 transition shadow-md dark:bg-gray-700 dark:text-gray-100">
            </div>

            <!-- Single Container for all filtered/categorized assets -->
            <div id="filtered-asset-container" class="space-y-3 pb-4">
                <!-- Asset cards will be rendered here based on active tab and search term -->
            </div>
            
        </div>

        <!-- Main Detail Area (Right) -->
        <div class="flex-grow p-6 overflow-y-auto bg-gray-100 dark:bg-gray-900 transition-all duration-300 ease-in-out">
            <div id="asset-detail-content" class="h-full bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col items-center justify-center border border-gray-200 dark:border-gray-700">
                <svg class="w-16 h-16 text-gray-300 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v14M9 19h12M9 19c0 1.105.9 2 2 2s2-.895 2-2M12 6c0 1.105.9 2 2 2s2-.895 2-2M12 6h3"></path></svg>
                <p class="text-gray-500 dark:text-gray-400 text-center">Select an asset from the left panel to view details and launch the 3D WebGL viewer.</p>
            </div>
        </div>
    </main>

    <!-- Unity WebGL Side Panel -->
    <div id="unity-panel" 
         class="fixed top-0 right-0 w-full lg:w-2/3 h-full bg-gray-900 shadow-2xl transform translate-x-full transition-transform duration-500 ease-in-out z-20 flex flex-col">
        
        <div class="p-4 bg-gray-800 text-white flex justify-between items-center shadow-lg border-b border-gray-700">
            <h3 id="panel-title" class="text-xl font-semibold text-emerald-400">3D Viewer: (Asset Name)</h3>
            <button onclick="toggleUnityPanel(false)" class="p-1 rounded-full hover:bg-gray-700 transition-colors">
                <!-- Close Icon (X) -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="flex-grow relative overflow-hidden bg-gray-800">
            <!-- This is the container for the Unity WebGL build -->
            <div id="unity-webgl-area" class="w-full h-full">
                <!-- The Unity loader will mount the canvas element with this ID inside the container above -->
                <canvas id="unity-canvas" class="block w-full h-full"></canvas> 
            </div>
            
            <div id="webgl-loading-text" class="absolute inset-0 flex items-center justify-center text-white bg-gray-900/80 transition-opacity duration-300 pointer-events-none">
                <div class="p-6 bg-gray-700 rounded-xl shadow-xl text-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-400 mx-auto mb-3"></div>
                    <p class="text-gray-100">Loading 3D Asset Environment...</p>
                    <p class="text-sm text-gray-400 mt-2">Connecting to Unity WebGL build. This may take a moment.</p>
                </div>
            </div>
        </div>

        <div class="p-4 bg-gray-700 text-white flex items-center justify-between">
            <p class="text-sm">3D Manipulation Tools:</p>
            <div class="space-x-2">
                <button class="px-3 py-1 text-sm rounded bg-gray-600 hover:bg-gray-500 transition-colors">Zoom</button>
                <button class="px-3 py-1 text-sm rounded bg-gray-600 hover:bg-gray-500 transition-colors">Inspect</button>
            </div>
        </div>

    </div>

    <script type="module">
        // --- UPDATED MOCK ASSET DATA (Now a flat array with 'category' and 'subcategory') ---
        const ASSETS_DATA = [
            // Environments
            { id: 'ENV01', name: 'Standard Operating Room', description: 'Full room environment for surgical training.', category: 'Environments', subcategory: 'Scene', subType: 'Room', complexity: 9, tags: ['OR', 'room', 'surgery'], assetAddress: 'Environments/OperatingRoom_01' },
            { id: 'ENV02', name: 'ICU Bedside Prop Kit', description: 'Small props for bedside training environment setup.', category: 'Environments', subcategory: 'Environment Props', subType: 'Props', complexity: 4, tags: ['icu', 'props', 'bed'], assetAddress: 'Environments/ICU_PropKit' },
            { id: 'ENV03', name: 'Laparoscopy Authoring Template', description: 'Pre-authored environment for specific procedure.', category: 'Environments', subcategory: 'Authored Environments', subType: 'Template', complexity: 6, tags: ['laparoscopy', 'template'], assetAddress: 'Environments/Laparoscopy_Template' },

            // Tools (Mapped from old Equipment/Procedures)
            { id: 'T001', name: 'Defibrillator (AED)', description: 'Interactive model for shocking procedure training.', category: 'Tools', subcategory: 'Tools', subType: 'Electronic', complexity: 6, tags: ['heart', 'electric', 'emergency'], assetAddress: 'Equipment/AED_01' },
            { id: 'T002', name: 'IV Pump', description: 'Detailed model for infusion rate and alarm training.', category: 'Tools', subcategory: 'Tools', subType: 'Electronic', complexity: 9, tags: ['infusion', 'drug', 'medication'], assetAddress: 'Equipment/IVPump_02' },
            { id: 'T003', name: 'Empty Syringe Vessel', description: 'Standard empty vessel model for liquid injection.', category: 'Tools', subcategory: 'Empty Vessels', subType: 'Container', complexity: 2, tags: ['syringe', 'injection', 'empty'], assetAddress: 'Tools/Syringe_Empty' },
            { id: 'T004', name: 'CPR Basic Life Support Sequence', description: 'Step-by-step 3D sequence of BLS compressions.', category: 'Tools', subcategory: 'Procedures', subType: 'Animation', complexity: 7, tags: ['resuscitation', 'training', 'chest'], assetAddress: 'Procedures/CPR_Animation_BLS' },
            { id: 'T005', name: 'Custom IV Bag (Saline)', description: 'User-defined custom vessel with programmed content.', category: 'Tools', subcategory: 'Custom Vessels', subType: 'Container', complexity: 3, tags: ['bag', 'saline', 'custom'], assetAddress: 'Tools/CustomIVBag_01' },
            
            // Characters
            { id: 'C001', name: 'Standard Male Patient', description: 'A baseline model for training scenarios.', category: 'Characters', subcategory: 'Characters', subType: 'Humanoid', complexity: 7, tags: ['man', 'patient', 'basic'], assetAddress: 'Characters/PatientMale_01' },
            { id: 'C002', name: 'Pediatric Dummy', description: 'Model suitable for child resuscitation training.', category: 'Characters', subcategory: 'Characters', subType: 'Mannequin', complexity: 5, tags: ['child', 'dummy', 'cpr'], assetAddress: 'Characters/Dummy_Pediatric_01' },
            { id: 'C003', name: 'Female Surgical Scrubs', description: 'Outfit asset for female surgical staff.', category: 'Characters', subcategory: 'Outfits', subType: 'Clothing', complexity: 3, tags: ['scrubs', 'surgeon', 'clothing'], assetAddress: 'Characters/Outfit_ScrubsFemale' },
            { id: 'C004', name: 'Default American Voice', description: 'Standard, clear voice profile for patient dialogue.', category: 'Characters', subcategory: 'Voice Profiles', subType: 'Audio', complexity: 1, tags: ['voice', 'audio', 'default'], assetAddress: 'Characters/VoiceProfile_01' },
            { id: 'C005', name: 'Breathing Animations Set', description: 'A collection of breathing animations (normal, rapid, shallow).', category: 'Characters', subcategory: 'Animation Groups', subType: 'Animation', complexity: 2, tags: ['breathing', 'animations', 'set'], assetAddress: 'Characters/AnimGroup_Breathing' },
            
            // Other
            { id: 'OTH01', name: 'Severe Laceration', description: 'A texture/model group representing a deep wound.', category: 'Other', subcategory: 'Wounds', subType: 'Visual', complexity: 4, tags: ['injury', 'skin', 'trauma'], assetAddress: 'Other/Wound_Laceration' },
            { id: 'OTH02', name: 'Fever Condition Profile', description: 'A profile defining fever vitals and symptoms.', category: 'Other', subcategory: 'Conditions', subType: 'Profile', complexity: 2, tags: ['fever', 'condition', 'vitals'], assetAddress: 'Other/Condition_Fever' },
            { id: 'OTH03', name: 'Patient History Intake Protocol', description: 'A step-by-step non-3D procedure for history taking.', category: 'Other', subcategory: 'Procedures', subType: 'Protocol', complexity: 3, tags: ['protocol', 'intake', 'non-3d'], assetAddress: 'Other/Protocol_Intake' },

        ];
        // --- END UPDATED MOCK ASSET DATA ---


        // Global state and helper structures
        let UnityInstance = null; 
        let activeMainCategory = 'All';
        let activeSubcategory = 'All'; // 'All' means all subcategories within the activeMainCategory
        let allAssets = [];

        // --- CATEGORY AND SUBCATEGORY DEFINITIONS ---
        const CATEGORIES = {
            'All': { icon: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>', tooltip: 'View All Assets' },
            'Environments': { icon: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-2a3 3 0 013-3h3a3 3 0 013 3v2"></path></svg>', tooltip: 'Scenes, Props & Authored Environments' },
            'Tools': { icon: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h10a1 1 0 011 1v11a1 1 0 01-1 1H7a1 1 0 01-1-1V8a1 1 0 011-1zm0 0l-2-2m2 2l2-2m-2 2v2M9 12h.01M15 12h.01M15 16h.01"></path></svg>', tooltip: 'Equipment, Vessels & Procedures' },
            'Characters': { icon: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>', tooltip: 'Models, Outfits & Voice Profiles' },
            'Other': { icon: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>', tooltip: 'Wounds, Conditions, & Miscellaneous' },
        };

        const SUBCATEGORIES = {
            'Environments': [
                { name: 'Scene', key: 'Scene' },
                { name: 'Authored Environments', key: 'Authored Environments' },
                { name: 'Environment Props', key: 'Environment Props' }
            ],
            'Tools': [
                { name: 'Tools', key: 'Tools' },
                { name: 'Procedures', key: 'Procedures' },
                { name: 'Empty Vessels', key: 'Empty Vessels' },
                { name: 'Custom Vessels', key: 'Custom Vessels' }
            ],
            'Characters': [
                { name: 'Characters', key: 'Characters' },
                { name: 'Outfits', key: 'Outfits' },
                { name: 'Animation Groups', key: 'Animation Groups' },
                { name: 'Voice Profiles', key: 'Voice Profiles' }
            ],
            'Other': [
                { name: 'Procedures', key: 'Procedures' },
                { name: 'Conditions', key: 'Conditions' },
                { name: 'Wounds', key: 'Wounds' }
            ]
        };
        // --- END CATEGORY AND SUBCATEGORY DEFINITIONS ---
        
        // --- Firebase Setup (Required to prevent runtime errors in Canvas) ---
        // Note: Imports are outside this script block in the HTML standard for modules.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // --- END Firebase Setup ---

        // --- UI/Panel Logic ---
        const unityPanel = document.getElementById('unity-panel');
        const panelTitle = document.getElementById('panel-title');
        const assetDetailContent = document.getElementById('asset-detail-content');
        const loadingText = document.getElementById('webgl-loading-text');
        
        // Configuration object for the Unity instance
        const unityConfig = {
            dataUrl: "Build/WebGL.data",
            frameworkUrl: "Build/WebGL.framework.js",
            codeUrl: "Build/WebGL.wasm",
            streamingAssetsUrl: "TemplateData/StreamingAssets",
            companyName: "YourCompanyName",
            productName: "AssetViewer",
            productVersion: "1.0",
        };

        // Toggles the dark mode class on the HTML element
        function toggleDarkMode() {
            const html = document.documentElement;
            const isDarkMode = html.classList.toggle('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');

            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            
            if (isDarkMode) {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }
        
        // Initialize dark mode preference on load
        function initDarkMode() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            const html = document.documentElement;
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                html.classList.add('dark');
                if (sunIcon && moonIcon) {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                }
            } else {
                html.classList.remove('dark');
                if (sunIcon && moonIcon) {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            }

            document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);
        }


        /**
         * Toggles the visibility of the Unity WebGL side panel.
         * @param {boolean} show - True to open, false to close.
         * @param {string} assetName - The name of the asset being viewed.
         * @param {object} assetData - The full asset object to initialize the Unity state.
         */
        function toggleUnityPanel(show, assetName = 'Not Loaded', assetData = null) {
            if (show) {
                unityPanel.classList.remove('translate-x-full');
                panelTitle.textContent = `3D Viewer: ${assetName}`;
                
                loadingText.classList.remove('opacity-0', 'pointer-events-none');
                
                // Load/Re-initialize Unity and pass data
                loadUnityWebGL(assetData); 

            } else {
                unityPanel.classList.add('translate-x-full');
                
                // Optionally quit the Unity instance to free resources (recommended)
                if (UnityInstance) { 
                    // UnityInstance.Quit(); 
                }
                UnityInstance = null;
            }
        }

        /**
         * Loads or initializes the Unity WebGL application and sends the asset data.
         * @param {object} asset - The full asset object to send to Unity.
         */
        function loadUnityWebGL(asset) {
            
            if (UnityInstance) {
                sendAssetDataToUnity(asset);
                return;
            }

            const canvas = document.getElementById("unity-canvas");

            if (typeof createUnityInstance !== 'undefined') {
                createUnityInstance(canvas, unityConfig, (progress) => {
                    console.log(`Unity Loading Progress: ${progress * 100}%`);
                }).then((instance) => {
                    UnityInstance = instance;
                    loadingText.classList.add('opacity-0', 'pointer-events-none');
                    sendAssetDataToUnity(asset);
                }).catch((message) => {
                    console.error("Unity failed to load:", message);
                    loadingText.innerHTML = `<div class="p-6 bg-red-700 rounded-xl shadow-xl text-white text-center">Error Loading Unity. Check console for details.</div>`;
                });
            } else {
                 console.error("UnityLoader function (createUnityInstance) not found. Check your script path in the <head>.");
                 loadingText.classList.remove('opacity-0', 'pointer-events-none');
                 loadingText.innerHTML = `<div class="p-6 bg-red-700 rounded-xl shadow-xl text-white text-center">Unity Loader not found. Check Console.</div>`;
            }
        }

        /**
         * Serializes the asset data and sends it to the Unity instance via SendMessage.
         * @param {object} asset - The full asset object to send to Unity.
         */
        function sendAssetDataToUnity(asset) {
            // Note: The category property is passed here, now representing the main category.
            const payloadObject = {
                Type: asset.category, 
                Address: asset.assetAddress, 
                AssetId: asset.id,
                AssetComplexity: asset.complexity,
                AdditionalData: `Viewing asset ${asset.id}, Subcategory: ${asset.subcategory}`
            };

            const jsonPayload = JSON.stringify(payloadObject);
            
            if (UnityInstance) {
                UnityInstance.SendMessage('AssetManager', 'InitializeAsset', jsonPayload);
                console.log('[Unity Bridge] Data Sent:', jsonPayload);
            } else {
                console.warn('Unity instance not ready. Data will be sent once loading completes.');
            }
        }
        // --- END Unity WebGL Logic ---

        // Helper function to find an asset by its ID in the flat list
        function findAssetById(id) {
            return allAssets.find(asset => asset.id === id);
        }

        /**
         * Starts the editing mode for the asset address (using createElement for robustness).
         * @param {string} assetId - The ID of the asset to edit.
         */
        function startEditAddress(assetId) {
            const asset = findAssetById(assetId);
            if (!asset) return;

            const displayContainer = document.getElementById('display-address');
            const editContainer = document.getElementById('edit-address');
            
            if (!displayContainer || !editContainer) return;

            displayContainer.classList.add('hidden');
            editContainer.classList.remove('hidden');
            editContainer.innerHTML = ''; // Clear previous content

            // Create the main flex container
            const flexDiv = document.createElement('div');
            flexDiv.className = 'flex space-x-2';

            // Create the input field
            const input = document.createElement('input');
            input.type = 'text';
            input.id = 'new-address-input';
            input.value = asset.assetAddress;
            input.className = 'flex-grow p-2 border border-emerald-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 text-sm shadow-sm dark:bg-gray-700 dark:text-gray-100';
            input.placeholder = 'Enter new asset address (e.g., Characters/NewModel_01)';
            
            // Create Save button
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.className = 'px-3 py-1 bg-emerald-500 text-white text-sm font-medium rounded-lg hover:bg-emerald-600 transition duration-150 shadow-md';
            saveBtn.onclick = () => saveNewAddress(assetId);

            // Create Cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'px-3 py-1 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition duration-150';
            cancelBtn.onclick = () => cancelEditAddress(assetId);

            // Append elements
            flexDiv.appendChild(input);
            flexDiv.appendChild(saveBtn);
            flexDiv.appendChild(cancelBtn);
            editContainer.appendChild(flexDiv);

            input.focus();
        }

        /**
         * Saves the new asset address to the global data structures.
         * @param {string} assetId - The ID of the asset to save.
         */
        function saveNewAddress(assetId) {
            const newAddressInput = document.getElementById('new-address-input');
            const newAddress = newAddressInput ? newAddressInput.value.trim() : '';

            if (!newAddress) {
                console.error("Asset Address cannot be empty. Reverting edit.");
                cancelEditAddress(assetId);
                return;
            }

            // 1. Update the flat list (allAssets)
            const assetToUpdate = findAssetById(assetId);
            if (assetToUpdate) {
                assetToUpdate.assetAddress = newAddress;

                // 2. Re-render the UI
                renderAssetDetails(assetToUpdate); // Re-render the detail panel
                renderFilteredList(document.getElementById('asset-search').value); // Re-render the list to update the card
            }
        }

        /**
         * Cancels the editing mode for the asset address.
         * @param {string} assetId - The ID of the asset to cancel editing for.
         */
        function cancelEditAddress(assetId) {
            const asset = findAssetById(assetId);
            if (!asset) return;

            const displayContainer = document.getElementById('display-address');
            const editContainer = document.getElementById('edit-address');

            if (displayContainer && editContainer) {
                // Ensure the current address text is correct before reverting
                const currentAddressSpan = document.getElementById('current-address');
                if(currentAddressSpan) currentAddressSpan.textContent = asset.assetAddress;
                
                editContainer.classList.add('hidden');
                displayContainer.classList.remove('hidden');
            }
        }


        /**
         * Renders the details of a selected asset and sets up the viewer button.
         * @param {object} asset - The asset object.
         */
        function renderAssetDetails(asset) {
            assetDetailContent.innerHTML = `
                <div class="w-full">
                    <h2 class="text-3xl font-extrabold text-gray-900 dark:text-gray-100 mb-2">${asset.name}</h2>
                    <!-- Show both category and subcategory -->
                    <p class="text-indigo-600 dark:text-emerald-400 text-lg mb-6">${asset.category} / ${asset.subcategory} | ID: ${asset.id}</p>
                    
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl border border-gray-200 dark:border-gray-600 shadow-inner">
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">Description</h3>
                        <p class="text-gray-600 dark:text-gray-300">${asset.description}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-3">Complexity: ${asset.complexity} | Sub-Type: ${asset.subType || 'N/A'}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Tags: ${asset.tags ? asset.tags.join(', ') : 'None'}</p>
                        
                        <!-- Asset Address Edit Area -->
                        <div id="address-container" class="mt-3 py-1">
                            <!-- Display Mode -->
                            <div id="display-address" class="flex justify-between items-center">
                                <p class="text-sm text-gray-700 dark:text-gray-300">
                                    <span class="font-semibold text-gray-500 dark:text-gray-400">Asset Address:</span> 
                                    <span id="current-address">${asset.assetAddress}</span>
                                </p>
                                <button onclick="startEditAddress('${asset.id}')" class="text-indigo-600 dark:text-emerald-400 hover:text-indigo-800 dark:hover:text-emerald-600 text-sm font-medium p-1 rounded-md transition duration-150 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                    Edit
                                </button>
                            </div>
                            <!-- Edit Mode (Initially Hidden) -->
                            <div id="edit-address" class="hidden">
                                <!-- Content dynamically generated by startEditAddress function -->
                            </div>
                        </div>
                        <!-- End Asset Address Edit Area -->
                    </div>

                    <div class="mt-8">
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-3">Asset Manipulation</h3>
                        <!-- Button calls a function to pass the full asset object (JSON encoded) -->
                        <button onclick='toggleUnityPanel(true, "${asset.name}", ${JSON.stringify(asset)})' 
                                class="px-6 py-3 bg-emerald-500 text-gray-900 font-bold text-lg rounded-xl hover:bg-emerald-600 transition duration-200 shadow-lg flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Launch 3D WebGL Viewer
                        </button>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Open the interactive viewer for 360° inspection.</p>
                    </div>
                </div>
            `;
        }

        /**
         * Selects a main category tab and triggers a re-render.
         * @param {string} categoryName - The main category to select ('All', 'Environments', etc.).
         */
        function selectMainCategory(categoryName) {
            activeMainCategory = categoryName;
            activeSubcategory = 'All'; // Reset subcategory when main category changes

            // Update Tab UI
            document.querySelectorAll('.main-tab-button').forEach(btn => {
                const category = btn.getAttribute('data-category');
                if (category === activeMainCategory) {
                    btn.classList.add('bg-emerald-500', 'text-gray-900', 'shadow-md');
                    btn.classList.remove('text-gray-600', 'hover:bg-gray-200', 'dark:text-gray-300', 'dark:hover:bg-gray-600');
                } else {
                    btn.classList.remove('bg-emerald-500', 'text-gray-900', 'shadow-md');
                    btn.classList.add('text-gray-600', 'hover:bg-gray-200', 'dark:text-gray-300', 'dark:hover:bg-gray-600');
                }
            });

            renderSubcategoryTabs();
            document.getElementById('asset-search').value = '';
            renderFilteredList('');
        }

        /**
         * Renders the subcategory tabs for the active main category.
         */
        function renderSubcategoryTabs() {
            const container = document.getElementById('subcategory-tabs');
            const containerWrapper = document.getElementById('subcategory-container');
            container.innerHTML = '';

            if (activeMainCategory === 'All' || !SUBCATEGORIES[activeMainCategory]) {
                // Hide the subcategory bar
                containerWrapper.classList.add('opacity-0', 'max-h-0');
                containerWrapper.classList.remove('opacity-100', 'max-h-48');
                return;
            }

            // Show the subcategory bar
            containerWrapper.classList.remove('opacity-0', 'max-h-0');
            containerWrapper.classList.add('opacity-100', 'max-h-48'); // max-h-48 allows smooth transition

            // Add 'All' subcategory tab first
            createSubcategoryButton({ name: 'All', key: 'All' }, container);

            // Add specific subcategory tabs
            SUBCATEGORIES[activeMainCategory].forEach(sub => {
                createSubcategoryButton(sub, container);
            });
        }

        /**
         * Creates and appends a single subcategory button.
         * @param {object} subcategory - The subcategory data.
         * @param {HTMLElement} container - The container element.
         */
        function createSubcategoryButton(subcategory, container) {
            const tabButton = document.createElement('button');
            const isActive = subcategory.key === activeSubcategory;

            // FIX: Added 'cursor-pointer' class
            tabButton.className = `subcategory-button cursor-pointer px-3 py-1 text-xs font-medium rounded-full transition duration-150 shadow-sm
                ${isActive ? 'bg-indigo-500 text-white' : 'text-gray-600 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500'}`;
            tabButton.textContent = subcategory.name;
            tabButton.setAttribute('data-subcategory', subcategory.key);
            tabButton.onclick = () => selectSubcategory(subcategory.key);
            container.appendChild(tabButton);
        }


        /**
         * Selects a subcategory tab and triggers a re-render.
         * @param {string} subcategoryName - The subcategory to select ('Scene', 'Tools', etc.).
         */
        function selectSubcategory(subcategoryName) {
            activeSubcategory = subcategoryName;

            // Update Tab UI
            document.querySelectorAll('.subcategory-button').forEach(btn => {
                const subcategory = btn.getAttribute('data-subcategory');
                if (subcategory === activeSubcategory) {
                    btn.classList.add('bg-indigo-500', 'text-white');
                    btn.classList.remove('bg-gray-200', 'dark:bg-gray-600', 'text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-500');
                } else {
                    btn.classList.remove('bg-indigo-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'dark:bg-gray-600', 'text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-500');
                }
            });

            document.getElementById('asset-search').value = '';
            renderFilteredList('');
        }

        /**
         * Filters the asset list based on the active main category, subcategory, and search term.
         * @param {string} searchTerm - The text entered in the search box.
         */
        function renderFilteredList(searchTerm = '') {
            const container = document.getElementById('filtered-asset-container');
            container.innerHTML = '';

            let currentList = allAssets;

            // 1. Filter by Main Category
            if (activeMainCategory !== 'All') {
                currentList = currentList.filter(asset => asset.category === activeMainCategory);
            }

            // 2. Filter by Subcategory (only if a main category is selected AND a specific subcategory is chosen)
            if (activeMainCategory !== 'All' && activeSubcategory !== 'All') {
                 currentList = currentList.filter(asset => asset.subcategory === activeSubcategory);
            }

            // 3. Filter by Search Term
            if (searchTerm) {
                const lowerSearchTerm = searchTerm.toLowerCase();
                currentList = currentList.filter(asset => {
                    const searchString = `${asset.name} ${asset.id} ${asset.description} ${asset.subType} ${asset.category} ${asset.subcategory} ${asset.tags ? asset.tags.join(' ') : ''} ${asset.assetAddress || ''}`.toLowerCase();
                    return searchString.includes(lowerSearchTerm);
                });
            }
            
            if (currentList.length === 0) {
                const filterText = activeMainCategory === 'All' 
                    ? 'All Assets' 
                    : activeMainCategory + (activeSubcategory !== 'All' ? ' / ' + activeSubcategory : '');

                container.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 p-6 rounded-xl bg-white dark:bg-gray-700 shadow-inner">No assets found in ${filterText} matching your search.</p>`;
            } else {
                currentList.forEach(asset => {
                    const button = document.createElement('button');
                    button.className = 'asset-card w-full text-left p-4 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 border border-gray-200 dark:border-gray-600 rounded-xl transition duration-150 shadow-md transform hover:shadow-lg';
                    button.innerHTML = `
                        <div class="flex flex-col">
                            <span class="font-bold text-base text-indigo-700 dark:text-emerald-400">${asset.name}</span>
                            <!-- Show both category and subcategory -->
                            <span class="text-xs text-gray-500 dark:text-gray-400 mt-1">ID: ${asset.id} | Type: ${asset.category} / ${asset.subcategory} | Address: ${asset.assetAddress || 'N/A'}</span>
                            <span class="text-sm text-gray-600 dark:text-gray-300 mt-1">${asset.description.substring(0, 80)}...</span>
                        </div>
                    `;
                    button.onclick = () => renderAssetDetails(asset);
                    container.appendChild(button);
                });
            }
        }

        // --- Tooltip Logic ---
        let tooltipTimeout;

        function showTooltip(element, text) {
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(() => {
                let tooltip = document.getElementById('app-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.id = 'app-tooltip';
                    tooltip.className = 'fixed bg-gray-800 text-white text-xs px-3 py-1.5 rounded-lg shadow-xl opacity-0 transition-opacity duration-200 z-50 whitespace-nowrap';
                    document.body.appendChild(tooltip);
                }
                
                tooltip.textContent = text;
                
                const rect = element.getBoundingClientRect();
                tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
                tooltip.style.top = `${rect.bottom + 8}px`;
                
                tooltip.classList.remove('opacity-0');
                tooltip.classList.add('opacity-100');
            }, 500);
        }

        function hideTooltip() {
            clearTimeout(tooltipTimeout);
            const tooltip = document.getElementById('app-tooltip');
            if (tooltip) {
                tooltip.classList.remove('opacity-100');
                tooltip.classList.add('opacity-0');
            }
        }
        // --- End Tooltip Logic ---


        /**
         * Initializes the asset data, tabs, and event listeners.
         */
        function initializeAssetList() {
            // 1. Set allAssets from the new flat data array
            allAssets = ASSETS_DATA;

            // 2. Initialize Category Tabs (Main tabs)
            const tabsContainer = document.getElementById('category-tabs');
            Object.keys(CATEGORIES).forEach(category => {
                const tabButton = document.createElement('button');
                tabButton.className = 'main-tab-button flex-1 p-2 rounded-xl text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition duration-150 relative';
                tabButton.innerHTML = CATEGORIES[category].icon;
                tabButton.setAttribute('data-category', category);
                tabButton.onclick = () => selectMainCategory(category);
                
                // Tooltip setup
                tabButton.onmouseover = () => showTooltip(tabButton, CATEGORIES[category].tooltip);
                tabButton.onmouseleave = hideTooltip;
                tabButton.onfocus = () => selectMainCategory(category);

                tabsContainer.appendChild(tabButton);
            });

            // 3. Initialize Search Listener
            const searchInput = document.getElementById('asset-search');
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    renderFilteredList(e.target.value);
                }, 150);
            });

            // 4. Select default category, render subcategories (hidden) and render list
            selectMainCategory(activeMainCategory);

            // 5. Select the first asset for display in the detail panel
            if (allAssets.length > 0) {
                renderAssetDetails(allAssets[0]);
            }
        }

        // Initialize the app when the window loads
        window.onload = () => {
            initDarkMode();
            initializeAssetList();
        }

    </script>
</body>
</html>
