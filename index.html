<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Training Asset Database</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 
    *** UNITY WEBGL INTEGRATION: STEP 1 (Add Unity Loader Script) ***
    1. Replace 'YourBuildName.loader.js' with the actual name of the loader script 
       created by your Unity build (it's usually [ProjectName].loader.js).
    -->
    <script src="Build/WebGL.loader.js"></script> 
    
    <style>
        /* Custom styles for the WebGL container */
        #unity-webgl-area {
            height: 100%;
            width: 100%;
            display: flex; 
            justify-content: center;
            align-items: center;
        }
        /* Hide scrollbar for aesthetics */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Style the canvas specifically for Unity (Unity will often handle this dynamically) */
        #unity-canvas {
            width: 100%;
            height: 100%;
            /* Ensure the canvas is display block and fills its container */
            display: block; 
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans antialiased h-screen overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
        <h1 class="text-2xl font-bold text-indigo-700">Training Asset Catalog</h1>
        <button id="view-mode-button" class="px-4 py-2 bg-indigo-500 text-white text-sm font-medium rounded-full hover:bg-indigo-600 transition duration-150 shadow-md">
            Asset Dashboard
        </button>
    </header>

    <!-- Main Content and Sidebar Container -->
    <main class="flex-grow flex overflow-hidden">
        
        <!-- Asset List (Left Panel) -->
        <div id="asset-list" class="w-full lg:w-96 p-4 border-r border-gray-200 bg-white overflow-y-auto no-scrollbar flex-shrink-0 transition-all duration-300 ease-in-out">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Available Assets (Click to View 3D)</h2>
            
            <!-- Category Tab Bar -->
            <div id="category-tabs" class="flex justify-around p-1 bg-indigo-100 rounded-xl mb-4 shadow-inner">
                <!-- Tabs will be dynamically created here by JS -->
            </div>

            <!-- Search Bar -->
            <div class="mb-4">
                <input type="text" id="asset-search" placeholder="Search by Name, ID, Tags, or Description..." 
                       class="w-full p-2 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition shadow-md">
            </div>

            <!-- Single Container for all filtered/categorized assets -->
            <div id="filtered-asset-container" class="space-y-3 pb-4">
                <!-- Asset cards will be rendered here based on active tab and search term -->
            </div>
            
        </div>

        <!-- Main Detail Area (Right) -->
        <div class="flex-grow p-6 overflow-y-auto bg-gray-100 transition-all duration-300 ease-in-out">
            <div id="asset-detail-content" class="h-full bg-white p-6 rounded-xl shadow-lg flex flex-col items-center justify-center">
                <svg class="w-16 h-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v14M9 19h12M9 19c0 1.105.9 2 2 2s2-.895 2-2M12 6c0 1.105.9 2 2 2s2-.895 2-2M12 6h3"></path></svg>
                <p class="text-gray-500 text-center">Select an asset from the left panel to view details and launch the 3D WebGL viewer.</p>
            </div>
        </div>
    </main>

    <!-- Unity WebGL Side Panel -->
    <div id="unity-panel" 
         class="fixed top-0 right-0 w-full lg:w-2/3 h-full bg-gray-900 shadow-2xl transform translate-x-full transition-transform duration-500 ease-in-out z-20 flex flex-col">
        
        <div class="p-4 bg-indigo-700 text-white flex justify-between items-center shadow-lg">
            <h3 id="panel-title" class="text-xl font-semibold">3D Viewer: (Asset Name)</h3>
            <button onclick="toggleUnityPanel(false)" class="p-1 rounded-full hover:bg-indigo-600 transition-colors">
                <!-- Close Icon (X) -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="flex-grow relative overflow-hidden bg-gray-800">
            <!-- This is the container for the Unity WebGL build -->
            <div id="unity-webgl-area" class="w-full h-full">
                <!-- The Unity loader will mount the canvas element with this ID inside the container above -->
                <canvas id="unity-canvas" class="block w-full h-full"></canvas> 
            </div>
            
            <div id="webgl-loading-text" class="absolute inset-0 flex items-center justify-center text-white bg-gray-900/80 transition-opacity duration-300 pointer-events-none">
                <div class="p-6 bg-gray-700 rounded-xl shadow-xl text-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-3"></div>
                    <p>Loading 3D Asset Environment...</p>
                    <p class="text-sm text-gray-400 mt-2">Connecting to Unity WebGL build. This may take a moment.</p>
                </div>
            </div>
        </div>

        <div class="p-4 bg-gray-700 text-white flex items-center justify-between">
            <p class="text-sm">3D Manipulation Tools:</p>
            <div class="space-x-2">
                <button class="px-3 py-1 text-sm rounded bg-gray-600 hover:bg-gray-500 transition-colors">Zoom</button>
                <button class="px-3 py-1 text-sm rounded bg-gray-600 hover:bg-gray-500 transition-colors">Inspect</button>
            </div>
        </div>

    </div>

    <script>
        // Mock Asset Data
        const ASSETS = {
            'Characters': [
                { id: 'C001', name: 'Standard Male Patient', description: 'A baseline model for training scenarios.', category: 'Characters', subType: 'Humanoid', complexity: 7, tags: ['man', 'patient', 'basic'] },
                { id: 'C002', name: 'Pediatric Dummy', description: 'Model suitable for child resuscitation training.', category: 'Characters', subType: 'Mannequin', complexity: 5, tags: ['child', 'dummy', 'cpr'] },
                { id: 'C003', name: 'Female Surgical Staff', description: 'Customizable character for role-play.', category: 'Characters', subType: 'Humanoid', complexity: 8, tags: ['woman', 'surgeon', 'nurse'] },
            ],
            'Equipment': [
                { id: 'E001', name: 'Defibrillator (AED)', description: 'Interactive model for shocking procedure training.', category: 'Equipment', subType: 'Electronic', complexity: 6, tags: ['heart', 'electric', 'emergency'] },
                { id: 'E002', name: 'IV Pump', description: 'Detailed model for infusion rate and alarm training.', category: 'Equipment', subType: 'Electronic', complexity: 9, tags: ['infusion', 'drug', 'medication'] },
                { id: 'E003', name: 'Laparoscope', description: 'High-fidelity surgical instrument model.', category: 'Equipment', subType: 'Tool', complexity: 4, tags: ['surgery', 'scope', 'camera'] },
            ],
            'Procedures': [
                { id: 'P001', name: 'CPR Basic Life Support', description: 'Step-by-step 3D sequence of BLS compressions.', category: 'Procedures', subType: 'Animation', complexity: 7, tags: ['resuscitation', 'training', 'chest'] },
                { id: 'P002', name: 'Surgical Gowning', description: 'Visualization of sterile field and donning process.', category: 'Procedures', subType: 'Tutorial', complexity: 3, tags: ['clean', 'sterile', 'scrubs'] },
            ]
        };

        // Global state and helper structures
        // UnityInstance must be defined here, but will be assigned by the UnityLoader.js script
        let UnityInstance = null; 
        let activeCategory = 'All';
        let allAssets = [];

        const CATEGORIES = {
            'All': { icon: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>', tooltip: 'View All Assets' },
            'Characters': { icon: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>', tooltip: 'Patient & Staff Models' },
            'Equipment': { icon: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h10a1 1 0 011 1v11a1 1 0 01-1 1H7a1 1 0 01-1-1V8a1 1 0 011-1zm0 0l-2-2m2 2l2-2m-2 2v2M9 12h.01M15 12h.01M15 16h.01"></path></svg>', tooltip: 'Medical Devices & Tools' },
            'Procedures': { icon: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>', tooltip: 'Surgical & Emergency Protocols' },
        };
        
        // --- Firebase Setup (Required to prevent runtime errors in Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // --- END Firebase Setup ---

        // --- UI/Panel Logic ---
        const unityPanel = document.getElementById('unity-panel');
        const panelTitle = document.getElementById('panel-title');
        const assetDetailContent = document.getElementById('asset-detail-content');
        const loadingText = document.getElementById('webgl-loading-text');
        
        // Configuration object for the Unity instance
        const unityConfig = {
            dataUrl: "Build/WebGL.data", // Update this path
            frameworkUrl: "Build/WebGL.framework.js", // Update this path
            codeUrl: "Build/WebGL.wasm", // Update this path
            // The template may have additional paths (e.g., memoryUrl, symbolUrl)
            streamingAssetsUrl: "TemplateData/StreamingAssets",
            companyName: "YourCompanyName",
            productName: "AssetViewer",
            productVersion: "1.0",
            // Other settings from your Unity WebGL Template
        };


        /**
         * Toggles the visibility of the Unity WebGL side panel.
         * @param {boolean} show - True to open, false to close.
         * @param {string} assetName - The name of the asset being viewed.
         * @param {object} assetData - The full asset object to initialize the Unity state.
         */
        function toggleUnityPanel(show, assetName = 'Not Loaded', assetData = null) {
            if (show) {
                unityPanel.classList.remove('translate-x-full');
                panelTitle.textContent = `3D Viewer: ${assetName}`;
                
                loadingText.classList.remove('opacity-0', 'pointer-events-none');
                
                // Load/Re-initialize Unity and pass data
                loadUnityWebGL(assetData); 

            } else {
                unityPanel.classList.add('translate-x-full');
                
                // Optionally quit the Unity instance to free resources (recommended)
                if (UnityInstance) { 
                    // UnityInstance.Quit(); 
                    // The Quit() call typically handles cleanup.
                    // If you don't call Quit(), the instance will remain in memory.
                }
                UnityInstance = null; // Clear the reference
            }
        }

        /**
         * Loads or initializes the Unity WebGL application and sends the asset data.
         * @param {object} asset - The full asset object to send to Unity.
         */
        function loadUnityWebGL(asset) {
            
            // If the UnityInstance is already running, just send the new data
            if (UnityInstance) {
                sendAssetDataToUnity(asset);
                return;
            }

            // 1. Get the canvas element where Unity will render
            const canvas = document.getElementById("unity-canvas");

            // 2. Initialize the Unity Instance (UnityLoader is provided by the script in the <head>)
            // NOTE: This assumes you are using a standard Unity WebGL template (not the new optimized one).
            // If using a custom template, consult its setup documentation.
            // If using the standard template:
            if (typeof createUnityInstance !== 'undefined') { // Check if the loader function is available
                createUnityInstance(canvas, unityConfig, (progress) => {
                    // Update loading progress here if needed
                    console.log(`Unity Loading Progress: ${progress * 100}%`);
                }).then((instance) => {
                    // Unity is loaded and ready
                    UnityInstance = instance;
                    loadingText.classList.add('opacity-0', 'pointer-events-none');
                    sendAssetDataToUnity(asset);
                }).catch((message) => {
                    // Handle load error
                    console.error("Unity failed to load:", message);
                    loadingText.innerHTML = `<div class="p-6 bg-red-700 rounded-xl shadow-xl text-white text-center">Error Loading Unity. Check console for details.</div>`;
                });
            } else {
                 // Fallback if the script in the <head> hasn't loaded (or if we are missing it entirely)
                 console.error("UnityLoader function (createUnityInstance) not found. Check your script path in the <head>.");
                 loadingText.classList.remove('opacity-0', 'pointer-events-none');
                 loadingText.innerHTML = `<div class="p-6 bg-red-700 rounded-xl shadow-xl text-white text-center">Unity Loader not found. Check Console.</div>`;
            }
        }

        /**
         * Serializes the asset data and sends it to the Unity instance via SendMessage.
         * @param {object} asset - The full asset object to send to Unity.
         */
        function sendAssetDataToUnity(asset) {
             // 1. Prepare the data payload (keys match the C# class structure)
            const payloadObject = {
                AssetType: asset.category,
                AssetId: asset.id,
                AssetComplexity: asset.complexity,
                AdditionalData: `Viewing asset ${asset.id}`
            };

            // 2. Convert the complex object into a JSON string
            const jsonPayload = JSON.stringify(payloadObject);
            
            if (UnityInstance) {
                // Argument 1: Name of the GameObject with the receiving C# script (e.g., "AssetManager")
                // Argument 2: Name of the public C# method (which MUST take one string argument)
                // Argument 3: The JSON string payload
                UnityInstance.SendMessage('AssetManager', 'InitializeAsset', jsonPayload);
                console.log('[Unity Bridge] Data Sent:', jsonPayload);
            } else {
                console.warn('Unity instance not ready. Data will be sent once loading completes.');
            }
        }
        // --- END Unity WebGL Logic ---

        /**
         * Renders the details of a selected asset and sets up the viewer button.
         * @param {object} asset - The asset object.
         */
        function renderAssetDetails(asset) {
            assetDetailContent.innerHTML = `
                <div class="w-full">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-2">${asset.name}</h2>
                    <p class="text-indigo-600 text-lg mb-6">${asset.category} Asset | ID: ${asset.id}</p>
                    
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-inner">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Description</h3>
                        <p class="text-gray-600">${asset.description}</p>
                        <p class="text-sm text-gray-500 mt-3">Complexity: ${asset.complexity} | Sub-Type: ${asset.subType || 'N/A'}</p>
                        <p class="text-sm text-gray-500 mt-1">Tags: ${asset.tags ? asset.tags.join(', ') : 'None'}</p>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3">Asset Manipulation</h3>
                        <!-- Button calls a function to pass the full asset object (JSON encoded) -->
                        <button onclick='toggleUnityPanel(true, "${asset.name}", ${JSON.stringify(asset)})' 
                                class="px-6 py-3 bg-green-500 text-white font-bold text-lg rounded-xl hover:bg-green-600 transition duration-200 shadow-lg flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Launch 3D WebGL Viewer
                        </button>
                        <p class="text-sm text-gray-500 mt-2">Open the interactive viewer for 360° inspection.</p>
                    </div>
                </div>
            `;
        }

        /**
         * Selects a category tab and triggers a re-render of the asset list.
         * @param {string} categoryName - The category to select ('All', 'Characters', etc.).
         */
        function selectCategory(categoryName) {
            activeCategory = categoryName;

            // Update Tab UI
            document.querySelectorAll('.tab-button').forEach(btn => {
                const category = btn.getAttribute('data-category');
                if (category === activeCategory) {
                    btn.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
                    btn.classList.remove('text-gray-600', 'hover:bg-indigo-200');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
                    btn.classList.add('text-gray-600', 'hover:bg-indigo-200');
                }
            });

            // Clear search input and render the list for the new category
            document.getElementById('asset-search').value = '';
            renderFilteredList('');
        }

        /**
         * Filters the asset list based on the active category and search term.
         * @param {string} searchTerm - The text entered in the search box.
         */
        function renderFilteredList(searchTerm = '') {
            const container = document.getElementById('filtered-asset-container');
            container.innerHTML = ''; // Clear previous results

            let currentList = allAssets;

            // 1. Filter by Category
            if (activeCategory !== 'All') {
                currentList = allAssets.filter(asset => asset.category === activeCategory);
            }

            // 2. Filter by Search Term (search across name, id, description, subType, and tags)
            if (searchTerm) {
                const lowerSearchTerm = searchTerm.toLowerCase();
                currentList = currentList.filter(asset => {
                    const searchString = `${asset.name} ${asset.id} ${asset.description} ${asset.subType} ${asset.tags ? asset.tags.join(' ') : ''}`.toLowerCase();
                    return searchString.includes(lowerSearchTerm);
                });
            }
            
            // 3. Render Results
            if (currentList.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 p-6 rounded-xl bg-white shadow-inner">No assets found in ${activeCategory} matching your search.</p>`;
            } else {
                currentList.forEach(asset => {
                    const button = document.createElement('button');
                    button.className = 'asset-card w-full text-left p-4 bg-white hover:bg-indigo-50 border border-gray-200 rounded-xl transition duration-150 shadow-md transform hover:shadow-lg';
                    button.innerHTML = `
                        <div class="flex flex-col">
                            <span class="font-bold text-base text-indigo-700">${asset.name}</span>
                            <span class="text-xs text-gray-500 mt-1">ID: ${asset.id} | Type: ${asset.category} | Tags: ${asset.tags ? asset.tags.join(', ') : 'None'}</span>
                            <span class="text-sm text-gray-600 mt-1">${asset.description.substring(0, 80)}...</span>
                        </div>
                    `;
                    button.onclick = () => renderAssetDetails(asset);
                    container.appendChild(button);
                });
            }
        }

        // --- Tooltip Logic ---
        let tooltipTimeout;

        function showTooltip(element, text) {
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(() => {
                let tooltip = document.getElementById('app-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.id = 'app-tooltip';
                    tooltip.className = 'fixed bg-gray-800 text-white text-xs px-3 py-1.5 rounded-lg shadow-xl opacity-0 transition-opacity duration-200 z-50 whitespace-nowrap';
                    document.body.appendChild(tooltip);
                }
                
                tooltip.textContent = text;
                
                // Position the tooltip dynamically
                const rect = element.getBoundingClientRect();
                tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
                tooltip.style.top = `${rect.bottom + 8}px`;
                
                tooltip.classList.remove('opacity-0');
                tooltip.classList.add('opacity-100');
            }, 500); // 500ms delay for tooltip to appear
        }

        function hideTooltip() {
            clearTimeout(tooltipTimeout);
            const tooltip = document.getElementById('app-tooltip');
            if (tooltip) {
                tooltip.classList.remove('opacity-100');
                tooltip.classList.add('opacity-0');
            }
        }
        // --- End Tooltip Logic ---


        /**
         * Initializes the asset data, tabs, and event listeners.
         */
        function initializeAssetList() {
            // 1. Flatten all assets into one array
            Object.keys(ASSETS).forEach(category => {
                ASSETS[category].forEach(asset => allAssets.push(asset));
            });

            // 2. Initialize Category Tabs
            const tabsContainer = document.getElementById('category-tabs');
            Object.keys(CATEGORIES).forEach(category => {
                const tabButton = document.createElement('button');
                tabButton.className = 'tab-button flex-1 p-2 rounded-xl text-gray-600 hover:bg-indigo-200 transition duration-150 relative';
                tabButton.innerHTML = CATEGORIES[category].icon;
                tabButton.setAttribute('data-category', category);
                tabButton.onclick = () => selectCategory(category);
                
                // Tooltip setup
                tabButton.onmouseover = () => showTooltip(tabButton, CATEGORIES[category].tooltip);
                tabButton.onmouseleave = hideTooltip;
                tabButton.onfocus = () => selectCategory(category); // Tab to select

                tabsContainer.appendChild(tabButton);
            });

            // 3. Initialize Search Listener
            const searchInput = document.getElementById('asset-search');
            // Use a slight debounce for performance on fast typing
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    renderFilteredList(e.target.value);
                }, 150); // Small debounce time
            });

            // 4. Select default category and render list
            selectCategory(activeCategory);

            // 5. Select the first asset for display in the detail panel
            if (allAssets.length > 0) {
                renderAssetDetails(allAssets[0]);
            }
        }

        // Initialize the app when the window loads
        window.onload = initializeAssetList;

    </script>
</body>
</html>
